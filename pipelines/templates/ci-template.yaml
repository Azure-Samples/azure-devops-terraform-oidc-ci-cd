---
parameters:
  - name: root_module_folder_relative_path
    default: '.'

stages:
  - stage: validate
    displayName: Validation Terraform
    jobs:
      - job: validate
        displayName: Validate Terraform
        pool:
          ${environments[keys(environments)[0]].agent_pool_configuration}
        steps:
          - template: helpers/terraform-installer.yaml
            parameters:
              terraformVersion: 'latest'
          - pwsh: |
              terraform `
              -chdir="$${{ parameters.root_module_folder_relative_path }}" `
              fmt `
              -check
            displayName: Terraform Format Check
          - pwsh: |
              terraform `
              -chdir="$${{ parameters.root_module_folder_relative_path }}" `
              init `
              -backend=false
            displayName: Terraform Init
          - pwsh: |
              terraform `
              -chdir="$${{ parameters.root_module_folder_relative_path }}" `
              validate
            displayName: Terraform Validate

%{ for environment in environments ~}
      - deployment: ${environment.name}_plan
        variables:
          - group: ${environment.variable_group_name}
        dependsOn: validate
        displayName: Validate Terraform Plan for ${environment.display_name}
        pool:
          ${environment.agent_pool_configuration}
        environment: ${environment.environment_name}
        timeoutInMinutes: 0
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  displayName: Checkout Terraform Module
                - template: helpers/terraform-installer.yaml
                  parameters:
                    terraformVersion: 'latest'
                - template: helpers/terraform-init.yaml
                  parameters:
                    serviceConnection: '${environment.service_connection_name_plan}'
                    backendAzureResourceGroupName: $(BACKEND_AZURE_RESOURCE_GROUP_NAME)
                    backendAzureStorageAccountName: $(BACKEND_AZURE_STORAGE_ACCOUNT_NAME)
                    backendAzureStorageAccountContainerName: $(BACKEND_AZURE_STORAGE_ACCOUNT_CONTAINER_NAME)
                    root_module_folder_relative_path: $${{ parameters.root_module_folder_relative_path }}
                - template: helpers/terraform-plan.yaml
                  parameters:
                    serviceConnection: '${environment.service_connection_name_plan}'
                    root_module_folder_relative_path: $${{ parameters.root_module_folder_relative_path }}
                    additionalVariables: $(ADDITIONAL_ENVIRONMENT_VARIABLES)
%{ endfor ~}